<Window x:Class="VANTAGE.Dialogs.ProgressScanDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
        xmlns:skinManager="clr-namespace:Syncfusion.SfSkinManager;assembly=Syncfusion.SfSkinManager.WPF"
        skinManager:SfSkinManager.Theme="{skinManager:SkinManagerExtension ThemeName=FluentDark}"
        Title="Scan Progress Sheets"
        Height="600"
        Width="1050"
        WindowStartupLocation="CenterOwner"
        Background="{StaticResource BackgroundColor}"
        ResizeMode="CanResize"
        MinHeight="500"
        MinWidth="900"
        WindowStyle="SingleBorderWindow">

    <Grid Margin="20">
        <!-- STEP 1: Upload Panel -->
        <Grid x:Name="panelUpload" Visibility="Visible">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <TextBlock Grid.Row="0"
                       Text="Select Files to Scan"
                       FontSize="16"
                       FontWeight="SemiBold"
                       Foreground="{StaticResource ForegroundColor}"
                       Margin="0,0,0,15"/>

            <!-- Drop Zone -->
            <Border Grid.Row="1"
                    x:Name="dropZone"
                    Background="{StaticResource ControlBackground}"
                    BorderBrush="{StaticResource ControlBorder}"
                    BorderThickness="2"
                    CornerRadius="8"
                    AllowDrop="True"
                    Drop="DropZone_Drop"
                    DragEnter="DropZone_DragEnter"
                    DragLeave="DropZone_DragLeave">
                <Grid>
                    <!-- Empty state -->
                    <StackPanel x:Name="emptyDropState"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center">
                        <TextBlock Text="ðŸ“„"
                                   FontSize="48"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,10"/>
                        <TextBlock Text="Drag and drop files here"
                                   FontSize="14"
                                   Foreground="{StaticResource TextColorSecondary}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="or"
                                   FontSize="12"
                                   Foreground="{StaticResource TextColorSecondary}"
                                   HorizontalAlignment="Center"
                                   Margin="0,8"/>
                        <Button x:Name="btnBrowse"
                                Content="Browse Files"
                                Width="120"
                                Height="32"
                                Click="BtnBrowse_Click"
                                Background="{StaticResource ControlBackground}"
                                Foreground="{StaticResource AccentColor}"
                                BorderBrush="{StaticResource AccentColor}"
                                ToolTip="Select PDF or image files"/>
                        <TextBlock Text="Supported: PDF, PNG, JPG"
                                   FontSize="11"
                                   Foreground="{StaticResource TextColorSecondary}"
                                   HorizontalAlignment="Center"
                                   Margin="0,12,0,0"/>
                    </StackPanel>

                    <!-- Files list (shown when files selected) -->
                    <Grid x:Name="filesListState" Visibility="Collapsed" Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Selected Files"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource ForegroundColor}"
                                       VerticalAlignment="Center"/>
                            <Button Content="+ Add More"
                                    Margin="15,0,0,0"
                                    Padding="8,4"
                                    Click="BtnBrowse_Click"
                                    Background="Transparent"
                                    Foreground="{StaticResource AccentColor}"
                                    BorderThickness="0"
                                    Cursor="Hand"/>
                            <Button Content="Clear All"
                                    Margin="10,0,0,0"
                                    Padding="8,4"
                                    Click="BtnClearFiles_Click"
                                    Background="Transparent"
                                    Foreground="{StaticResource TextColorSecondary}"
                                    BorderThickness="0"
                                    Cursor="Hand"/>
                        </StackPanel>

                        <ListBox x:Name="lstFiles"
                                 Grid.Row="1"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   Text="âœ“"
                                                   Foreground="{StaticResource StatusGreen}"
                                                   Margin="0,0,8,0"
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding FileName}"
                                                   Foreground="{StaticResource ForegroundColor}"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Grid.Column="2"
                                                   Text="{Binding PageInfo}"
                                                   Foreground="{StaticResource TextColorSecondary}"
                                                   Margin="10,0"
                                                   VerticalAlignment="Center"/>
                                        <Button Grid.Column="3"
                                                Content="âœ•"
                                                Tag="{Binding FilePath}"
                                                Click="BtnRemoveFile_Click"
                                                Background="Transparent"
                                                Foreground="{StaticResource TextColorSecondary}"
                                                BorderThickness="0"
                                                Padding="5,2"
                                                Cursor="Hand"
                                                ToolTip="Remove file"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Grid>
            </Border>

            <!-- Summary -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,15,0,0">
                <TextBlock Text="Total Pages:"
                           Foreground="{StaticResource TextColorSecondary}"
                           VerticalAlignment="Center"/>
                <TextBlock x:Name="txtTotalPages"
                           Text="0"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource ForegroundColor}"
                           Margin="8,0,0,0"
                           VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Buttons -->
            <StackPanel Grid.Row="3"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,15,0,0">
                <Button x:Name="btnStartProcessing"
                        Content="Start Processing"
                        Width="130"
                        Height="32"
                        Margin="0,0,10,0"
                        Click="BtnStartProcessing_Click"
                        IsEnabled="False"
                        Background="{StaticResource ControlBackground}"
                        Foreground="{StaticResource StatusGreen}"
                        BorderBrush="{StaticResource ControlBorder}"
                        ToolTip="Process selected files with AI vision"/>
                <Button Content="Cancel"
                        Width="80"
                        Height="32"
                        Click="BtnCancel_Click"
                        Background="{StaticResource ControlBackground}"
                        Foreground="{StaticResource ForegroundColor}"
                        BorderBrush="{StaticResource ControlBorder}"/>
            </StackPanel>
        </Grid>

        <!-- STEP 2: Processing Panel -->
        <Grid x:Name="panelProcessing" Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="Processing Scanned Sheets"
                           FontSize="18"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource ForegroundColor}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,30"/>

                <syncfusion:SfLinearProgressBar x:Name="progressBar"
                                                 Width="400"
                                                 Height="8"
                                                 Minimum="0"
                                                 Maximum="100"
                                                 Progress="0"
                                                 TrackColor="{StaticResource ControlBackground}"
                                                 ProgressColor="{StaticResource AccentColor}"/>

                <TextBlock x:Name="txtProcessingStatus"
                           Text="Initializing..."
                           FontSize="14"
                           Foreground="{StaticResource ForegroundColor}"
                           HorizontalAlignment="Center"
                           Margin="0,20,0,0"/>

                <TextBlock x:Name="txtExtractedCount"
                           Text="Extracted: 0 entries"
                           FontSize="12"
                           Foreground="{StaticResource TextColorSecondary}"
                           HorizontalAlignment="Center"
                           Margin="0,10,0,0"/>
            </StackPanel>

            <Button Grid.Row="1"
                    x:Name="btnCancelProcessing"
                    Content="Cancel"
                    Width="100"
                    Height="32"
                    HorizontalAlignment="Center"
                    Click="BtnCancelProcessing_Click"
                    Background="{StaticResource ControlBackground}"
                    Foreground="{StaticResource ForegroundColor}"
                    BorderBrush="{StaticResource ControlBorder}"/>
        </Grid>

        <!-- STEP 3: Review Panel -->
        <Grid x:Name="panelReview" Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Summary Header -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                <TextBlock Text="Review Extracted Data"
                           FontSize="16"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource ForegroundColor}"
                           VerticalAlignment="Center"/>
                <TextBlock x:Name="txtReviewSummary"
                           Text=""
                           FontSize="12"
                           Foreground="{StaticResource TextColorSecondary}"
                           VerticalAlignment="Center"
                           Margin="20,0,0,0"/>
            </StackPanel>

            <!-- Filter Buttons -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
                <RadioButton x:Name="rbFilterAll"
                             Content="All"
                             GroupName="ReviewFilter"
                             IsChecked="True"
                             Checked="FilterChanged"
                             Foreground="{StaticResource ForegroundColor}"
                             Margin="0,0,15,0"/>
                <RadioButton x:Name="rbFilterReady"
                             Content="Ready"
                             GroupName="ReviewFilter"
                             Checked="FilterChanged"
                             Foreground="{StaticResource StatusGreen}"
                             Margin="0,0,15,0"/>
                <RadioButton x:Name="rbFilterWarnings"
                             Content="Warnings"
                             GroupName="ReviewFilter"
                             Checked="FilterChanged"
                             Foreground="{StaticResource StatusYellow}"
                             Margin="0,0,15,0"/>
                <RadioButton x:Name="rbFilterErrors"
                             Content="Errors"
                             GroupName="ReviewFilter"
                             Checked="FilterChanged"
                             Foreground="{StaticResource ErrorText}"/>
            </StackPanel>

            <!-- Review Grid -->
            <Border Grid.Row="2"
                    Background="{StaticResource ControlBackground}"
                    BorderBrush="{StaticResource ControlBorder}"
                    BorderThickness="1"
                    CornerRadius="4">
                <syncfusion:SfDataGrid x:Name="sfReviewGrid"
                                       AutoGenerateColumns="False"
                                       AllowEditing="True"
                                       EditTrigger="OnTap"
                                       AllowSorting="True"
                                       AllowFiltering="True"
                                       AllowResizingColumns="True"
                                       SelectionMode="Single"
                                       SelectionUnit="Cell"
                                       NavigationMode="Cell"
                                       GridLinesVisibility="Horizontal"
                                       HeaderRowHeight="30"
                                       RowHeight="28"
                                       CurrentCellEndEdit="SfReviewGrid_CurrentCellEndEdit">
                    <syncfusion:SfDataGrid.HeaderStyle>
                        <Style TargetType="syncfusion:GridHeaderCellControl">
                            <Setter Property="Background" Value="{StaticResource GridHeaderBackground}"/>
                            <Setter Property="Foreground" Value="{StaticResource TextColorSecondary}"/>
                        </Style>
                    </syncfusion:SfDataGrid.HeaderStyle>
                    <syncfusion:SfDataGrid.Columns>
                        <syncfusion:GridCheckBoxColumn MappingName="IsSelected"
                                                       HeaderText="â˜‘"
                                                       Width="40"
                                                       AllowFiltering="False"/>
                        <syncfusion:GridTextColumn MappingName="ExtractedUniqueId"
                                                   HeaderText="ActID"
                                                   Width="70"
                                                   AllowEditing="False"
                                                   ToolTipTemplate="{x:Null}"/>
                        <syncfusion:GridTextColumn MappingName="MatchedUniqueId"
                                                   HeaderText="UniqueID"
                                                   Width="140"
                                                   AllowEditing="False"
                                                   ToolTipTemplate="{x:Null}"/>
                        <syncfusion:GridTextColumn MappingName="Description"
                                                   HeaderText="Description"
                                                   Width="200"
                                                   AllowEditing="False"
                                                   TextTrimming="CharacterEllipsis"/>
                        <syncfusion:GridTextColumn MappingName="BudgetMHs"
                                                   HeaderText="MHs"
                                                   Width="70"
                                                   AllowEditing="False"
                                                   ToolTipTemplate="{x:Null}"/>
                        <syncfusion:GridNumericColumn MappingName="CurrentPercent"
                                                      HeaderText="Cur %"
                                                      Width="75"
                                                      AllowEditing="False"
                                                      NumberDecimalDigits="1"/>
                        <syncfusion:GridNumericColumn MappingName="NewPercent"
                                                      HeaderText="New %"
                                                      Width="75"
                                                      AllowEditing="True"
                                                      NumberDecimalDigits="1">
                            <syncfusion:GridNumericColumn.HeaderTemplate>
                                <DataTemplate>
                                    <TextBlock Text="New %" ToolTip="Click to edit - correct OCR errors here"/>
                                </DataTemplate>
                            </syncfusion:GridNumericColumn.HeaderTemplate>
                        </syncfusion:GridNumericColumn>
                        <syncfusion:GridNumericColumn MappingName="Confidence"
                                                      HeaderText="Conf"
                                                      Width="65"
                                                      AllowEditing="False"/>
                        <syncfusion:GridTextColumn MappingName="ValidationMessage"
                                                   HeaderText="Status"
                                                   Width="150"
                                                   AllowEditing="False"/>
                    </syncfusion:SfDataGrid.Columns>
                </syncfusion:SfDataGrid>
            </Border>

            <!-- Bottom Actions -->
            <Grid Grid.Row="3" Margin="0,15,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Selection actions and rescan -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="Select All"
                            Padding="10,6"
                            Click="BtnSelectAll_Click"
                            Background="Transparent"
                            Foreground="{StaticResource AccentColor}"
                            BorderThickness="0"
                            Cursor="Hand"
                            ToolTip="Select all visible items"/>
                    <Button Content="Select Ready"
                            Padding="10,6"
                            Click="BtnSelectAllReady_Click"
                            Background="Transparent"
                            Foreground="{StaticResource AccentColor}"
                            BorderThickness="0"
                            Cursor="Hand"
                            ToolTip="Select Ready items and Warnings with confidence >= 70%"/>
                    <Button Content="Clear"
                            Padding="10,6"
                            Click="BtnClearSelection_Click"
                            Background="Transparent"
                            Foreground="{StaticResource TextColorSecondary}"
                            BorderThickness="0"
                            Cursor="Hand"
                            ToolTip="Clear all selections"/>
                    <TextBlock x:Name="txtSelectedCount"
                               Text="Selected: 0"
                               Foreground="{StaticResource TextColorSecondary}"
                               VerticalAlignment="Center"
                               Margin="20,0,0,0"/>

                    <!-- Rescan controls -->
                    <Border BorderBrush="{StaticResource ControlBorder}"
                            BorderThickness="1,0,0,0"
                            Margin="20,0,0,0"
                            Padding="15,0,0,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Contrast:"
                                       Foreground="{StaticResource TextColorSecondary}"
                                       VerticalAlignment="Center"
                                       ToolTip="Adjust only if scan returned incorrect values"/>
                            <Slider x:Name="sliderRescanContrast"
                                    Width="100"
                                    Minimum="1"
                                    Maximum="2"
                                    Value="1.2"
                                    TickFrequency="0.1"
                                    IsSnapToTickEnabled="True"
                                    Margin="8,0,0,0"
                                    VerticalAlignment="Center"
                                    ToolTip="Adjust only if scan returned incorrect values"/>
                            <TextBlock x:Name="txtRescanContrastValue"
                                       Text="1.2"
                                       Width="30"
                                       Foreground="{StaticResource ForegroundColor}"
                                       Margin="4,0,0,0"
                                       VerticalAlignment="Center"/>
                            <Button Content="Rescan"
                                    Padding="10,4"
                                    Margin="10,0,0,0"
                                    Click="BtnRescan_Click"
                                    Background="{StaticResource ControlBackground}"
                                    Foreground="{StaticResource AccentColor}"
                                    BorderBrush="{StaticResource AccentColor}"
                                    ToolTip="Re-process files with new contrast setting"/>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Right: Main buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Back"
                            Width="80"
                            Height="32"
                            Margin="0,0,10,0"
                            Click="BtnBackToUpload_Click"
                            Background="{StaticResource ControlBackground}"
                            Foreground="{StaticResource ForegroundColor}"
                            BorderBrush="{StaticResource ControlBorder}"
                            ToolTip="Go back to file selection"/>
                    <Button x:Name="btnApply"
                            Content="Apply Selected"
                            Width="120"
                            Height="32"
                            Margin="0,0,10,0"
                            Click="BtnApply_Click"
                            IsEnabled="False"
                            Background="{StaticResource ControlBackground}"
                            Foreground="{StaticResource StatusGreen}"
                            BorderBrush="{StaticResource ControlBorder}"
                            ToolTip="Apply selected progress updates"/>
                    <Button Content="Cancel"
                            Width="80"
                            Height="32"
                            Click="BtnCancel_Click"
                            Background="{StaticResource ControlBackground}"
                            Foreground="{StaticResource ForegroundColor}"
                            BorderBrush="{StaticResource ControlBorder}"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Grid>
</Window>
