<UserControl x:Class="VANTAGE.Views.ProgressBooksView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:pdfviewer="clr-namespace:Syncfusion.Windows.PdfViewer;assembly=Syncfusion.PdfViewer.WPF"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1200"
             Background="{DynamicResource BackgroundColor}">

    <UserControl.Resources>
        <!-- Default TextBlock style for visibility on dark background -->
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ForegroundColor}"/>
        </Style>

        <!-- Default TextBox style matching Admin dialogs -->
        <Style TargetType="TextBox">
            <Setter Property="Height" Value="28"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Background" Value="{DynamicResource BackgroundColor}"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundColor}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderColor}"/>
            <Setter Property="Padding" Value="5,3"/>
        </Style>

        <!-- RoundedButtonStyle and PrimaryButtonStyle loaded from Themes/SharedStyles.xaml -->
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header Bar -->
        <Border Grid.Row="0" Background="{DynamicResource ControlBackground}" Padding="15,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="Progress Books"
                           FontSize="18"
                           FontWeight="Bold"
                           VerticalAlignment="Center"/>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button x:Name="btnGenerateBook"
                            Content="GENERATE"
                            Style="{StaticResource PrimaryButtonStyle}"
                            ToolTip="Generate a PDF progress book with this layout"
                            Click="BtnGenerateBook_Click"
                            MinWidth="120"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content - Split View -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="LeftPanelColumn" Width="6*" MinWidth="350"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition x:Name="RightPanelColumn" Width="4*" MinWidth="300"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel - Configuration -->
            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" Padding="15">
                <StackPanel>
                    <!-- Layout Selection -->
                    <TextBlock Text="Layout" FontWeight="Bold" Margin="0,0,0,5"/>
                    <ComboBox x:Name="cboSavedLayouts"
                              ToolTip="Load a saved layout"
                              SelectionChanged="CboSavedLayouts_SelectionChanged"
                              Margin="0,0,0,10"/>

                    <!-- Delete Button (directly under Layout dropdown) -->
                    <Button x:Name="btnDeleteLayout" Content="Delete" Click="BtnDeleteLayout_Click" Padding="8,4" Margin="0,0,0,10" HorizontalAlignment="Left" ToolTip="Delete this layout"/>

                    <!-- Name -->
                    <TextBlock Text="Name" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBox x:Name="txtLayoutName"
                             ToolTip="Name for this layout configuration"
                             Margin="0,0,0,15"/>

                    <Separator Margin="0,0,0,15"/>

                    <!-- Paper Size -->
                    <TextBlock Text="Paper Size" FontWeight="Bold" Margin="0,0,0,5"/>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                        <RadioButton x:Name="rbLetter"
                                     Content="Letter (11&quot; x 8.5&quot;)"
                                     IsChecked="True"
                                     Foreground="{DynamicResource ForegroundColor}"
                                     Margin="0,0,20,0"
                                     Checked="PaperSize_Changed"
                                     ToolTip="Standard letter size, landscape orientation"/>
                        <RadioButton x:Name="rbTabloid"
                                     Content="Tabloid (17&quot; x 11&quot;)"
                                     Foreground="{DynamicResource ForegroundColor}"
                                     Checked="PaperSize_Changed"
                                     ToolTip="Larger tabloid size, landscape orientation"/>
                    </StackPanel>

                    <!-- Font Size -->
                    <TextBlock x:Name="txtFontSizeLabel" Text="Font Size: 10pt" FontWeight="Bold" Margin="0,0,0,5"/>
                    <Slider x:Name="sliderFontSize"
                            Minimum="4"
                            Maximum="10"
                            Value="8"
                            TickFrequency="1"
                            IsSnapToTickEnabled="True"
                            ValueChanged="SliderFontSize_ValueChanged"
                            ToolTip="Font size for data rows. Larger fonts improve Progress Scan accuracy."
                            Margin="0,0,0,5"/>
                    <TextBlock x:Name="txtDescFontNote"
                               Text="(DESC column renders at 9pt)"
                               FontSize="11"
                               Foreground="{DynamicResource TextColorSecondary}"
                               Margin="0,0,0,3"/>
                    <TextBlock x:Name="txtFontSizeWarning"
                               Text="Small font may reduce Progress Scan accuracy"
                               FontSize="11"
                               Foreground="{DynamicResource StatusYellow}"
                               Visibility="Collapsed"
                               Margin="0,0,0,15"/>

                    <!-- Select Progress Book(s) - Filter -->
                    <TextBlock Text="Select Progress Book(s)" FontWeight="Bold" Margin="0,0,0,5"/>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Text="Column" FontSize="11" Foreground="{DynamicResource TextColorSecondary}"/>
                        <TextBlock Grid.Column="2" Text="Value" FontSize="11" Foreground="{DynamicResource TextColorSecondary}"/>
                        <ComboBox x:Name="cboFilterColumn"
                                  Grid.Row="1"
                                  ToolTip="Field to filter records by"
                                  SelectionChanged="FilterColumn_SelectionChanged"/>
                        <ComboBox x:Name="cboFilterValue"
                                  Grid.Row="1"
                                  Grid.Column="2"
                                  ToolTip="Value to filter - this becomes the Progress Book name in the header"
                                  SelectionChanged="FilterValue_SelectionChanged"/>
                    </Grid>
                    <CheckBox x:Name="chkExcludeCompleted"
                              Content="Exclude Completed Activities"
                              Foreground="{DynamicResource ForegroundColor}"
                              Margin="0,10,0,0"
                              ToolTip="When checked, activities with 100% progress will not be included in the progress book"/>

                    <Separator Margin="0,15,0,15"/>

                    <!-- Grouping (groups are auto-sorted alphanumerically) -->
                    <TextBlock Text="Grouping" FontWeight="Bold" Margin="0,0,0,5"/>
                    <ItemsControl x:Name="icGroups" Margin="0,0,0,10">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ComboBox ItemsSource="{Binding AvailableFields}"
                                              SelectedItem="{Binding GroupField, Mode=TwoWay}"
                                              ToolTip="Group by this field (sorted alphanumerically)"/>
                                    <Button Grid.Column="1"
                                            Content="✕"
                                            Padding="6,2"
                                            Margin="5,0,0,0"
                                            Visibility="{Binding CanDelete, Converter={StaticResource BoolToVisibilityConverter}}"
                                            Click="BtnRemoveGroup_Click"
                                            Tag="{Binding Index}"
                                            ToolTip="Remove this grouping level"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <Button x:Name="btnAddGroup"
                            Content="+ Add Group"
                            Click="BtnAddGroup_Click"
                            Padding="8,4"
                            HorizontalAlignment="Left"
                            Margin="0,0,0,15"
                            ToolTip="Add another grouping level (max 10)"/>

                    <Separator Margin="0,0,0,15"/>

                    <!-- Zone 2 Columns (auto-fit widths) -->
                    <TextBlock Text="Columns" FontWeight="Bold" Margin="0,0,0,5"/>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ListBox x:Name="lstColumns"
                                 Height="180"
                                 Background="{DynamicResource BackgroundColor}"
                                 BorderBrush="{DynamicResource BorderColor}"
                                 ToolTip="Columns auto-size to fit content. UniqueID, ROC and DESC are required."/>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="10,0,0,0">
                            <Button Content="▲" Click="BtnMoveColumnUp_Click" Padding="8,4" Margin="0,0,0,5" ToolTip="Move up"/>
                            <Button Content="▼" Click="BtnMoveColumnDown_Click" Padding="8,4" Margin="0,0,0,5" ToolTip="Move down"/>
                            <Button Content="✕" Click="BtnRemoveColumn_Click" Padding="8,4" ToolTip="Remove"/>
                        </StackPanel>
                    </Grid>

                    <!-- Add Column Row -->
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox x:Name="cboAddColumn"
                                  ToolTip="Select a field to add"/>
                        <Button Grid.Column="1"
                                Content="+ Add"
                                Click="BtnAddColumn_Click"
                                Padding="8,4"
                                Margin="5,0,0,0"
                                ToolTip="Add column to list"/>
                    </Grid>

                    <Separator Margin="0,0,0,15"/>

                    <!-- Sort (stacking sort like Excel) -->
                    <TextBlock Text="Sort" FontWeight="Bold" Margin="0,0,0,5"/>
                    <ItemsControl x:Name="icSortFields" Margin="0,0,0,10">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ComboBox ItemsSource="{Binding AvailableFields}"
                                              SelectedItem="{Binding SortField, Mode=TwoWay}"
                                              ToolTip="Sort by this field (stacks with other sorts like Excel)"/>
                                    <Button Grid.Column="1"
                                            Content="✕"
                                            Padding="6,2"
                                            Margin="5,0,0,0"
                                            Visibility="{Binding CanDelete, Converter={StaticResource BoolToVisibilityConverter}}"
                                            Click="BtnRemoveSort_Click"
                                            Tag="{Binding Index}"
                                            ToolTip="Remove this sort level"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <Button x:Name="btnAddSort"
                            Content="+ Add Sort"
                            Click="BtnAddSort_Click"
                            Padding="8,4"
                            HorizontalAlignment="Left"
                            Margin="0,0,0,15"
                            ToolTip="Add another sort level (max 10)"/>

                    <!-- Save Button -->
                    <Button x:Name="btnSaveLayout"
                            Content="Save"
                            Style="{StaticResource RoundedButtonStyle}"
                            Click="BtnSaveLayout_Click"
                            HorizontalAlignment="Right"
                            MinWidth="100"/>
                </StackPanel>
            </ScrollViewer>

            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1"
                          Width="5"
                          HorizontalAlignment="Stretch"
                          Background="{DynamicResource BorderColor}"
                          Cursor="SizeWE"
                          DragCompleted="GridSplitter_DragCompleted"/>

            <!-- Right Panel - Preview -->
            <Grid Grid.Column="2" Background="{DynamicResource ControlBackground}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Preview Header -->
                <Border Grid.Row="0" Background="{DynamicResource BackgroundColor}" Padding="10">
                    <TextBlock Text="PREVIEW" FontWeight="Bold" VerticalAlignment="Center"/>
                </Border>

                <!-- Preview Content -->
                <Grid Grid.Row="1" Margin="5">
                    <!-- Placeholder shown before preview is generated -->
                    <Border x:Name="previewPlaceholderBorder"
                            Background="{DynamicResource ControlBackground}"
                            BorderBrush="{DynamicResource BorderColor}"
                            BorderThickness="1">
                        <TextBlock x:Name="txtPreviewPlaceholder"
                                   Text="PDF Preview Area&#x0a;&#x0a;Click 'Refresh Preview' to generate"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   TextAlignment="Center"
                                   Foreground="{DynamicResource TextColorSecondary}"
                                   FontStyle="Italic"/>
                    </Border>
                    <!-- PDF Viewer for preview -->
                    <pdfviewer:PdfViewerControl x:Name="pdfViewer"
                                                 Visibility="Collapsed"
                                                 EnableNotificationBar="False"/>
                </Grid>

                <!-- Refresh Button -->
                <Border Grid.Row="2" Background="{DynamicResource BackgroundColor}" Padding="10">
                    <Button x:Name="btnRefreshPreview"
                            Content="Refresh Preview"
                            Style="{StaticResource RoundedButtonStyle}"
                            Click="BtnRefreshPreview_Click"
                            HorizontalAlignment="Center"/>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
